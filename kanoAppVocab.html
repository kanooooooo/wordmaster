<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <title>wordMaster</title>
    </head>
    <body>

        <h1>単語クイズ</h1>
        <hr>
        <h2>出題範囲</h2>

        <input id = "startNo" type="number" size="10">start</input>
        <input id = "endNo" type="number" size="10">end</input>
        <input id = "n_choices" type="number" size="10">choices</input>
        <input type="button" onclick="wordMasterStart()" value="START">

        <form id="target">
            <input name="E_or_J" type="radio" value="en"> 英→日
            <input name="E_or_J" type="radio" value="jp"> 日→英
        </form>


        <h2>問題</h2>
        <div id="text_q"></div>
        <h2>選択</h2>
        <div id="text_s"></div>
        <h2>解答</h2>
        <div id="text_a"></div>

        <script type="text/javascript">

            //STARTを押してから解答開始
                const goolgeAPI_URL = 'https://script.google.com/macros/s/AKfycbw-s3m-OGkX6e1DM1FIwfvD1osBzwbd7808_nVTrE7iHU8mFd4KvLV__F9PsmrfzJ1ZRw/exec'
                // let request = new XMLHttpRequest();
                //     request.open('GET', goolgeAPI_URL, false);
                //     request.send("numberOfQuizes");
                //     if (request.status == 200){
                //         lastNo



                    //問題のスタートとエンドの初期値を設定する
                    const startbox = document.getElementById("startNo");
                    startbox.value = 1;
    　　　　　　　　　 var startNo = parseInt(startbox.value);

                    var endbox = document.getElementById("endNo");
                    endbox.value = 1500;
                    var endNo = 1500;  
                                    
                    /** startNoとendNoの設定 */
                    const choicebox = document.getElementById("n_choices");
                    choicebox.value = 8;
                    var  n_choices = parseInt(choicebox.value); 

                    const enjpbox = document.getElementById("target");
                    var enjplist = enjpbox.E_or_J;
                    enjplist.value = "en"

                function generateQuestions(){
                    
                    let request = new XMLHttpRequest();
                    request.open('GET', goolgeAPI_URL, false);
                    request.send(null);

                    
                    if (request.status == 200){
                        var data = JSON.parse(request.responseText);
                        console.log(data.length);
                        console.log("====================");
                        console.log(data);

                        console.log(startNo);
                        console.log(endNo);
                        console.log(endNo-startNo+1)

                        var targetData = [];
                        for(i = 0; i < 1500; i++){
                           var a = (data[i]).point;
                            if(a > 0){
                                console.log("i = " + i + ", point = " + data[i].point);
                                targetData.push(data[i]);
                            }
                        }


                        console.log(targetData)
                        console.log("<<<<<<<<<<<<<<<<<<<<<<<<<<<")
                        
                        console.log(targetData)
                        endNo = targetData.length;
                        endbox.value = endNo;
                        
                        /** 重複チェック用配列 */
                        var randoms = [startNo - 1];

                        var q = [];
                        
                        /** 重複チェックしながら乱数作成 */
                        for(j = startNo - 1; j <= endNo; j++){
                            for(i = 0; i <= n_choices - 2; i++){
                                while(true){
                                    var tmp = intRandom(startNo-1, endNo-1);
                                    if(!randoms.includes(tmp)){
                                        randoms.push(tmp);
                                        break;
                                    }
                                }
                            }
                            q.push(randoms);
                            randoms = [ j + 1 ];
                        }
                        console.log('????????????????????');
                        console.log(q.length);
                    }      




                    //問題と解答
                    qa = new Array(endNo-startNo+1);
                    
                    for(i = 0; i <= endNo-startNo; i++){
                        //qa[i] = [data[q[i][0]].en, data[q[i][0]].jp, data[q[i][1]].jp, data[q[i][2]].jp, data[q[i][3]].jp, data[q[i][4]].jp,　data[q[i][5]].jp,　data[q[i][6]].jp,　data[q[i][7]].jp,1]
                        qa[i] = new Array(n_choices + 2);

                        if( enjplist.value === "en" ){
                            qa[i][0] = (targetData[q[i][0]].en);
                        } else if( enjplist.value === "jp" ){
                            qa[i][0] = (targetData[q[i][0]].jp);
                        }
                        for(j = 0; j <= n_choices - 1; j++){
                            // console.log("++++++++++++++" + "i:" + i + ", j:" + j + ", size:" + q[i].length)
                            if (i==215) {
                                console.log("$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$")
                                console.log(q[i]);
                            }
                            if( enjplist.value === "en" ){
                                e = targetData[q[i][j]].jp;
                                qa[i][j + 1] = (e);

                            } else if( enjplist.value === "jp" ){
                                e = datwa[q[i][j]].en;
                                qa[i][j + 1] = (e);

                            }
                        }
                        qa[i][n_choices + 1] = 1; //正解の番号を入れる

                        qa[i][n_choices + 2] = targetData[i].no;

                        var ansNo = intRandom(1, n_choices);
                        qa[i][n_choices + 1] = ansNo;
                        var temp = qa[i][ansNo]; //入れ替える場所の選択肢を一旦保存
                        qa[i][ansNo] = qa[i][1];
                        qa[i][1] = temp;


                    }
                    console.log("///////////////////////////")
                    console.log(qa)

                }

                /** startNo以上endNo以下の整数値の乱数を返す */
                function intRandom(startNo, endNo){
                            return Math.floor( Math.random() * (endNo - startNo + 1)) + startNo;
                 }

                //英単語読み上げるための設定
                var synthes = new SpeechSynthesisUtterance();
                var voices = window.speechSynthesis.getVoices();
                console.log(voices)
                function speak(word) {
                    for (var i = 0; i < voices.length; i++){
                        if (voices[i].name == 'Alex') {
                            synthes.voice = voices[i];
                        }
                    }
                    synthes.volume = 1;
                    synthes.text = word;
                    synthes.lang = 'en-US';
                    speechSynthesis.speak(synthes);
                }



                //クイズの作成
                generateQuestions();

                //初期設定
                q_sel = n_choices; //選択肢の数

                function setReady() {
                    startNo = parseInt(startbox.value);
                    endNo = parseInt(endbox.value);
                    n_choices = parseInt(choicebox.value);
                    q_sel = n_choices;
                    enjplist = enjpbox.E_or_J;


                    generateQuestions();

                    count = 0; //問題番号
                    ansers = new Array(); //解答記録
                    ox = new Array(); //解答記録(O, X表示)

                    //最初の問題
                    quiz();
            }

            function wordMasterStart(){
                    setReady();
            }
                

            function timeOver(){
                anser(0, -1);

            }


                //問題表示
                function quiz() {
                    //タイマーのセットアップ
                    var timerId = setTimeout(timeOver, 10000);

                    var s, n;
                    //問題
                    document.getElementById("text_q").innerHTML = (count + 1) + "問目(" + (startNo + count) + "番目)：" + qa[count][0];
                    //選択肢
                    s = "";
                    for (n=1;n<=q_sel;n++) {
                    s += "【<a href='javascript:anser(" + n +  "," + timerId + ")'>" + n + "：" + qa[count][n] + "</a>】";
                    }
                    document.getElementById("text_s").innerHTML = s;

                    if( enjplist.value === "en" ){
                       speak(qa[count][0]);  
                    }

                    
                }

                //解答表示
                function anser(num, timerId) {
                    //タイマーをキャンセル
                    clearTimeout(timerId);
                    var s;
                    s = (count + 1) + "問目：";
                    //答え合わせ
                    if (num == qa[count][q_sel + 1]) {
                        //正解
                        s += "-1" + qa[count][num];
                        ansers[count] = "-1";
                        ox[count] = "○";
                    } else {
                        s += "1" + qa[count][num];
                        ansers[count] = "1";
                        ox[count] = "X";
                    }
                    document.getElementById("text_a").innerHTML = s;

                    //次の問題を表示
                    count++;
                    if (count < endNo - startNo + 1) {
                        quiz();
                    } else {
                        //終了
                        s = "<table border='2'><caption>成績発表</caption>";
                        //1行目
                        s += "<tr><th>問題</th>";
                        for (n=0;n<endNo - startNo + 1;n++) {
                        s += "<th>" + (n+1) + "</th>";
                        }
                        s += "</tr>";
                        //2行目
                        s += "<tr><th>成績</th>";
                        for (n=0;n<endNo - startNo + 1;n++) {
                        s += "<td>" + ox[n] + "</td>";
                        }
                        s += "</tr>";
                        s += "</table>";
                        console.log("!@#$!@#$!@#$!@#$!@#$!@#$!@#$!@#$!@#$")
                        console.log(ansers)
                        console.log("%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%")
                        console.log(ox)

                        for (n=0;n<endNo - startNo + 1;n++) {
                            if (ansers[n] == 1) {
                                s += "<p>" + "(" + (n+1) + ") " + "[" + qa[n][n_choices + 2] + "]" + qa[n][0] + "|" + qa[n][ qa[n][n_choices + 1] ] + "</p>";
                            }

                        }
                        
                        document.getElementById("text_q").innerHTML = s;


                        //結果をgoogleスプレッドシートに送信
                        var result = []
                        for (i = 0; i < ansers.length; i++){
                          result.push({"no":qa[i][n_choices + 2], "point":ansers[i]});
                        }

                       // "     " + "[" + qa[i][n_choices + 2] + "]" + "          " + ansers[i] + "\n"

                        //result = result.slice(0, -1)
                        console.log("**************")
                        console.log(result)
                        var xhr = new XMLHttpRequest();
                        xhr.open("POST", goolgeAPI_URL, true);
                        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                        xhr.send(JSON.stringify({"startNo":startNo, "endNo":endNo, "result":result}));


                        //次の選択肢
                        s = "【<a href='javascript:history.back()'>前のページに戻る</a>】";
                        s += "【<a href='javascript:setReady()'>テストをやり直す</a>】";
                        s += "【<a href=''>次の問題に進む</a>】";
                        document.getElementById("text_s").innerHTML = s;
                    }
            }
                        
        
        </script>

    </body>
</html>
